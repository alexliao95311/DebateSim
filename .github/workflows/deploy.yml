name: Deploy to Azure VM

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up SSH Connection
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.VM_SSH_KEY }}

      - name: Test SSH Connection
        run: |
          echo "Testing connection to ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "echo 'SSH connection successful'"

      - name: Deploy to VM
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "🚀 Starting deployment..."
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            
            echo "📁 Navigating to project directory..."
            cd /home/$(whoami)/DebateSim || { echo "Project directory not found"; exit 1; }
            
            echo "🔄 Pulling latest changes..."
            git pull origin main
            
            echo "🔄 Restarting Backend..."
            # More reliable way to find and kill processes
            pkill -f "uvicorn main:app" || echo "No existing backend process found"
            
            source .venv/bin/activate
            nohup uvicorn main:app --host 0.0.0.0 --port 5000 > backend.log 2>&1 &
            echo "Backend started with PID: $!"
            
            echo "🛠 Rebuilding Frontend..."
            cd frontend
            
            # Kill existing frontend process
            pkill -f "npx serve" || echo "No existing frontend process found"
            
            npm install
            npm run build
            nohup npx serve -s dist -l 3000 --no-clipboard --single > frontend.log 2>&1 &
            echo "Frontend started with PID: $!"
            
            echo "✅ Deployment Completed!"
          EOF